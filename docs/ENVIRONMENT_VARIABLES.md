# Environment Variable Management

ReVerse uses different environment files for different contexts:

## File Hierarchy

### `.env.example`
Template for local development. Copy this to `.env.local` to get started.

```bash
cp .env.example .env.local
```

### `.env.local` (for development)
Your local development environment variables. This file is **gitignored**.

**Used by:**
- `npm run dev`
- Local Next.js development server

### `.env.production` (for deployment)
Production environment variables. Generated by `deploy.sh` script or manually created.

**Used by:**
- `deploy.sh` script
- Docker Compose in production
- Copied to `.env` automatically during deployment

### `.env.production.example`
Template for production deployment. Shows all required production variables.

## How Docker Compose Loads Variables

The deployment script uses **explicit `--env-file` flags**:

```bash
docker compose --env-file .env.production up -d
```

This ensures Docker Compose uses `.env.production` instead of the default `.env`.

Additionally, the script copies `.env.production` to `.env` as a backup method, so you can also run Docker Compose commands manually:

```bash
# These work the same way:
docker compose --env-file .env.production ps
docker compose ps  # Uses .env (which is a copy of .env.production)
```

## Variable Precedence

When using Docker Compose, environment variables are loaded in this order (highest to lowest priority):

1. **Shell environment variables** (exported in terminal)
2. **`--env-file` flag** (e.g., `--env-file .env.production`)
3. **`.env` file** (fallback)
4. **`environment:` in docker-compose.yml**
5. **Dockerfile ENV directives**

## Best Practices

### Development
```bash
# 1. Copy template
cp .env.example .env.local

# 2. Edit with your values
nano .env.local

# 3. Run dev server (automatically uses .env.local)
npm run dev
```

### Production (Automated)
```bash
# Use deploy script - it handles everything
./scripts/deploy.sh -d myapp.com -k sk-ant-xxx
```

### Production (Manual)
```bash
# 1. Create .env.production
cp .env.production.example .env.production

# 2. Edit with production values
nano .env.production

# 3. Deploy with explicit env file
docker compose --env-file .env.production up -d
```

## Security Notes

- ✅ `.env.local` is gitignored (safe for secrets)
- ✅ `.env.production` is gitignored (safe for secrets)
- ✅ `.env` is gitignored (safe for secrets)
- ❌ `.env.example` is committed (no secrets here!)
- ❌ `.env.production.example` is committed (no secrets here!)

## Troubleshooting

### "Environment variable not found"

Check which file Docker Compose is using:

```bash
# See what variables Docker Compose sees
docker compose --env-file .env.production config | grep -A 20 environment
```

### "Wrong database credentials"

Verify the env file exists and has correct values:

```bash
cat .env.production | grep DATABASE_URL
```

### "Changes not taking effect"

1. Make sure you're editing the right file
2. Restart Docker Compose with the env file:
   ```bash
   docker compose --env-file .env.production down
   docker compose --env-file .env.production up -d
   ```

### "NEXT_PUBLIC_* variables not updating"

These variables are **baked into the build** at build time. You must rebuild:

```bash
docker compose --env-file .env.production build --no-cache
docker compose --env-file .env.production up -d
```

Or use the deploy script:

```bash
./scripts/deploy.sh -d myapp.com -k sk-ant-xxx
```

